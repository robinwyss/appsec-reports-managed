"""
Data models for vulnerability information.
"""

from dataclasses import dataclass
from typing import List, Optional, Dict
from datetime import datetime
from enum import Enum


class Severity(Enum):
    """Vulnerability severity levels."""
    CRITICAL = "CRITICAL"
    HIGH = "HIGH"
    MEDIUM = "MEDIUM"
    LOW = "LOW"
    NONE = "NONE"


@dataclass
class VulnerabilityData:
    """Structured vulnerability data for reporting."""
    
    security_problem_id: str
    display_id: str
    title: str
    cve_id: Optional[str]
    severity: Severity
    cvss_score: Optional[float]
    dss_score: Optional[float]
    risk_level: str
    first_seen_timestamp: int
    last_updated_timestamp: int
    status: str
    affected_entities: List[Dict]
    process_groups: List[str]
    hosts: List[str]
    management_zones: List[str]
    external_vulnerability_url: Optional[str]
    
    @property
    def first_seen(self) -> datetime:
        """Convert first seen timestamp to datetime."""
        return datetime.fromtimestamp(self.first_seen_timestamp / 1000)
    
    @property
    def last_updated(self) -> datetime:
        """Convert last updated timestamp to datetime."""
        return datetime.fromtimestamp(self.last_updated_timestamp / 1000)
    
    @property
    def is_critical(self) -> bool:
        """Check if vulnerability is critical severity."""
        return self.severity == Severity.CRITICAL
    
    @property
    def is_high(self) -> bool:
        """Check if vulnerability is high severity."""
        return self.severity == Severity.HIGH
    
    @classmethod
    def from_api_response(cls, api_data: Dict) -> 'VulnerabilityData':
        """
        Create VulnerabilityData from Dynatrace API response.
        
        Args:
            api_data: API response dictionary
            
        Returns:
            VulnerabilityData instance
        """
        # Extract risk assessment data
        risk_assessment = api_data.get('riskAssessment', {})
        
        # Determine severity
        severity_str = risk_assessment.get('riskLevel', 'NONE')
        try:
            severity = Severity(severity_str)
        except ValueError:
            severity = Severity.NONE
        
        # Extract hosts from relatedEntities.host
        related_entities = api_data.get('relatedEntities', {})
        hosts = [host['id'] for host in related_entities.get('hosts', [])]
        
        # Extract process groups from affectedEntities (entries starting with PROCESS_GROUP)
        affected_entities = api_data.get('affectedEntities', [])
        process_groups = [
            entity for entity in affected_entities 
            if isinstance(entity, str) and entity.startswith('PROCESS_GROUP')
        ]
        
        # Extract management zones
        management_zones = [
            mz['name'] for mz in api_data.get('managementZones', [])
        ]
        
        return cls(
            security_problem_id=api_data.get('securityProblemId', ''),
            display_id=api_data.get('displayId', ''),
            title=api_data.get('title', ''),
            cve_id=', '.join(api_data.get('cveIds', [])) or None,
            severity=severity,
            cvss_score=risk_assessment.get('baseRiskScore'),
            dss_score=api_data.get('riskScore'),
            risk_level=severity_str,
            first_seen_timestamp=api_data.get('firstSeenTimestamp', 0),
            last_updated_timestamp=api_data.get('lastUpdatedTimestamp', 0),
            status=api_data.get('status', 'UNKNOWN'),
            affected_entities=affected_entities,
            process_groups=process_groups,
            hosts=hosts,
            management_zones=management_zones,
            external_vulnerability_url=api_data.get('externalVulnerabilityUrl')
        )
